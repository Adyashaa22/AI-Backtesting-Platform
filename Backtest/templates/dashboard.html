<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <link rel="stylesheet" href="/static/allover.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="background"></div>
    <div class="overlay"></div>
    <div class="container2">
        <div class="header">
            <h1>üöÄ Live Trading Dashboard</h1>
            <button class="stop-trading-btn" id="stop-trading-btn" onclick="showStopModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill=red stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
                Stop Trading
            </button>
        </div>
        
        <div id="warning-banner" class="warning-banner"></div>
        
        <div class="ltp-display" id="ltp">‚Çπ190.00</div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Portfolio Value</div>
                <div class="metric-value" id="portfolio-value">‚Çπ100,000.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">P&L</div>
                <div class="metric-value" id="pnl">‚Çπ0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">P&L %</div>
                <div class="metric-value" id="pnl-percent">0.00%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Orders</div>
                <div class="metric-value" id="trades">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Closed Trades</div>
                <div class="metric-value" id="closed-trades">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Win Rate</div>
                <div class="metric-value" id="win-rate">0.00%</div>
            </div>
        </div>
        
        <div class="content-grid">
            <div class="chart-container1">
                <div class="chart-info">
                    <div class="chart-info-item">
                        Displaying: <span class="chart-info-value" id="candles-displayed">0</span> candles
                    </div>
                    <div class="chart-info-item">
                        Total: <span class="chart-info-value" id="candles-total">0</span> candles
                    </div>
                    <div class="chart-info-item">
                        Markers: <span class="chart-info-value" id="markers-displayed">0</span>
                    </div>
                </div>
                
                <div class="interaction-indicator" id="interaction-indicator">
                    ‚è∏ Chart paused - Updates queued
                </div>
                
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #26a69a;"></div>
                        <span>Bullish Candle</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef5350;"></div>
                        <span>Bearish Candle</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></div>
                        <span>Buy Signal</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%;"></div>
                        <span>Sell Signal</span>
                    </div>
                </div>
                <div id="chart"></div>
                <div class="tooltip-custom" id="marker-tooltip"></div>
            </div>
            
            <div class="trade-stats-container">
                <div class="section-title">Trading Statistics</div>
                
                <div id="open-position-container"></div>
                
                <div class="stat-row">
                    <span class="stat-label">Winning Trades</span>
                    <span class="stat-value positive" id="winning-trades">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Losing Trades</span>
                    <span class="stat-value negative" id="losing-trades">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Win</span>
                    <span class="stat-value positive" id="avg-win">‚Çπ0.00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Loss</span>
                    <span class="stat-value negative" id="avg-loss">‚Çπ0.00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Largest Win</span>
                    <span class="stat-value positive" id="largest-win">‚Çπ0.00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Largest Loss</span>
                    <span class="stat-value negative" id="largest-loss">‚Çπ0.00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Profit Factor</span>
                    <span class="stat-value" id="profit-factor">0.00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Expectancy</span>
                    <span class="stat-value" id="expectancy">‚Çπ0.00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Hold Time</span>
                    <span class="stat-value" id="avg-hold">0 min</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Sharpe Ratio</span>
                    <span class="stat-value" id="sharpe">0.00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Max Drawdown</span>
                    <span class="stat-value negative" id="drawdown">0.00%</span>
                </div>
            </div>
        </div>
        
        <div class="trades-table-container">
            <div class="table-header">
                <div class="section-title">Recent Completed Trades</div>
                <button class="download-btn" onclick="downloadTradesCSV()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download CSV Report
                </button>
            </div>
            <table class="trades-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Entry Price</th>
                        <th>Exit Price</th>
                        <th>Qty</th>
                        <th>Entry Time</th>
                        <th>Exit Time</th>
                        <th>Hold (min)</th>
                        <th>P&L</th>
                        <th>P&L %</th>
                        <th>P&L (Gross)</th>
                        <th>Fees</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="trades-tbody">
                    <tr>
                        <td colspan="13" style="text-align: center; color: #94a3b8;">No completed trades yet</td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination" id="pagination" style="display: none;">
                <div class="pagination-info" id="pagination-info">Showing 0-0 of 0</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prev-btn" onclick="changePage(-1)">‚Üê Previous</button>
                    <button class="pagination-btn" id="next-btn" onclick="changePage(1)">Next ‚Üí</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stop Trading Confirmation Modal -->
    <div class="modal" id="stop-modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Stop Paper Trading?</div>
            <div class="modal-body">
                Are you sure you want to stop paper trading?<br><br>
                Your session data will be saved and downloaded as a ZIP file containing:
                <ul style="margin: 15px 0 0 20px; line-height: 1.8;">
                    <li>Candles data (OHLCV)</li>
                    <li>Trade history</li>
                    <li>Session summary</li>
                </ul>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="hideStopModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmStopTrading()">Stop & Download</button>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            MAX_VISIBLE_CANDLES: 6,
            INITIAL_LOAD: 6,
            INTERACTION_TIMEOUT: 5000,
            UPDATE_INTERVAL: 1000,
        };

        // ==================== STATE MANAGEMENT ====================
        let chart;
        let candleSeries;
        let markerTooltip = document.getElementById('marker-tooltip');
        let interactionIndicator = document.getElementById('interaction-indicator');
        
        let chartState = {
            isUserInteracting: false,
            interactionTimeout: null,
            allCandles: [],
            displayedCandles: [],
            allMarkers: [],
            displayedMarkers: [],
            lastDisplayedTimestamp: null,
            totalCandlesFromServer: 0
        };
        
        let allTrades = [];
        let currentPage = 1;
        const tradesPerPage = 10;
        
        // ==================== STOP TRADING MODAL ====================
        function showStopModal() {
            document.getElementById('stop-modal').classList.add('active');
        }
        
        function hideStopModal() {
            document.getElementById('stop-modal').classList.remove('active');
        }
        
        function confirmStopTrading() {
            const stopBtn = document.getElementById('stop-trading-btn');
            stopBtn.disabled = true;
            stopBtn.textContent = 'Stopping...';
            
            fetch('/api/stop_trading', {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to stop trading');
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trading_session_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Redirect to config page after brief delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
            })
            .catch(error => {
                console.error('Error stopping trading:', error);
                alert('Error stopping trading: ' + error.message);
                stopBtn.disabled = false;
                stopBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    </svg>
                    Stop Trading
                `;
                hideStopModal();
            });
        }
        
        // ==================== CHART INITIALIZATION ====================
        function initChart() {
            const chartContainer = document.getElementById('chart');
            
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 500,
                layout: {
                    background: { color: 'transparent' },
                                textColor: '#ffffff',
                        },
                    grid: {
                            vertLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            horzLines: { color: 'rgba(255, 255, 255, 0.1)' },
                        },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#334155',
                },
                timeScale: {
                    borderColor: '#334155',
                    timeVisible: true,
                    secondsVisible: false,
                    rightOffset: 12,
                    fixLeftEdge: true,
                    barSpacing: 6,
                    minBarSpacing: 0.5,
                },
            });
            
            candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });
            
            window.addEventListener('resize', () => {
                chart.applyOptions({ 
                    width: chartContainer.clientWidth 
                });
            });
            
            setupInteractionDetection(chartContainer);
            setupCrosshairTooltips();
        }
        
        // ==================== INTERACTION DETECTION ====================
        function setupInteractionDetection(chartContainer) {
            const interactionEvents = ['mousedown', 'wheel', 'touchstart'];
            
            interactionEvents.forEach(event => {
                chartContainer.addEventListener(event, () => {
                    setUserInteracting(true);
                });
            });
            
            chartContainer.addEventListener('mouseleave', () => {
                setUserInteracting(false);
            });
        }
        
        function setUserInteracting(isInteracting) {
            chartState.isUserInteracting = isInteracting;
            
            if (isInteracting) {
                interactionIndicator.classList.add('active');
            } else {
                interactionIndicator.classList.remove('active');
            }
            
            if (chartState.interactionTimeout) {
                clearTimeout(chartState.interactionTimeout);
            }
            
            if (isInteracting) {
                chartState.interactionTimeout = setTimeout(() => {
                    chartState.isUserInteracting = false;
                    interactionIndicator.classList.remove('active');
                    applyPendingUpdates();
                }, CONFIG.INTERACTION_TIMEOUT);
            }
        }
        
        // ==================== CROSSHAIR TOOLTIPS ====================
        function setupCrosshairTooltips() {
            chart.subscribeCrosshairMove((param) => {
                if (!param.time || !param.point) {
                    markerTooltip.style.display = 'none';
                    return;
                }
                
                const markers = candleSeries.markers();
                const hoveredMarker = markers.find(marker => marker.time === param.time);
                
                if (hoveredMarker && hoveredMarker.tooltip) {
                    markerTooltip.innerHTML = hoveredMarker.tooltip;
                    markerTooltip.style.display = 'block';
                    markerTooltip.style.left = (param.point.x + 15) + 'px';
                    markerTooltip.style.top = (param.point.y - 20) + 'px';
                } else {
                    markerTooltip.style.display = 'none';
                }
            });
        }
        
        // ==================== TIMESTAMP PARSING ====================
        function parseTimestamp(timestamp) {
            if (!timestamp || typeof timestamp !== 'string') {
                console.error('Invalid timestamp format:', timestamp);
                return null;
            }

            try {
                const [datePart, timePart] = timestamp.split(' ');
                
                if (!datePart || !timePart) {
                    throw new Error('Invalid timestamp format');
                }

                const isoString = `${datePart}T${timePart}Z`;
                const date = new Date(isoString);
                
                if (isNaN(date.getTime())) {
                    throw new Error('Invalid date');
                }
                
                return Math.floor(date.getTime() / 1000);
            } catch (error) {
                console.error('Error parsing timestamp:', timestamp, error);
                return null;
            }
        }
        
        // ==================== CHART UPDATE LOGIC ====================
        function updateChart(data) {
            if (!data.candles || data.candles.length === 0) return;
            
            chartState.allCandles = data.candles;
            chartState.allMarkers = data.actions || [];
            chartState.totalCandlesFromServer = data.total_candles;
            
            document.getElementById('candles-total').textContent = data.total_candles;
            
            if (chartState.isUserInteracting) {
                updateMarkersForAllCandles();
            } else {
                displayLastNCandles(CONFIG.MAX_VISIBLE_CANDLES, data.current_candle);
            }
        }
        
        function displayLastNCandles(n, currentCandle) {
            const allCandles = [...chartState.allCandles];
            if (currentCandle) {
                allCandles.push(currentCandle);
            }

            if (allCandles.length === 0) {
                return;
            }

            chartState.displayedCandles = allCandles;

            const candleData = allCandles
                .map(c => ({
                    time: parseTimestamp(c.timestamp),
                    open: c.open,
                    high: c.high,
                    low: c.low,
                    close: c.close
                }))
                .filter(c => c.time !== null);

            if (candleData.length === 0) return;

            candleSeries.setData(candleData);
            updateMarkersForAllCandles();

            if (candleData.length > n) {
                chart.timeScale().setVisibleLogicalRange({
                    from: candleData.length - n - 1,
                    to: candleData.length - 1
                });
            } else {
                chart.timeScale().fitContent();
            }

            document.getElementById('candles-displayed').textContent = candleData.length;
        }
        
        function applyPendingUpdates() {
            console.log('Applying pending updates...');
            displayLastNCandles(CONFIG.MAX_VISIBLE_CANDLES);
        }
        
        // ==================== MARKER MANAGEMENT ====================
        function updateMarkersForAllCandles() {
            if (chartState.displayedCandles.length === 0) return;
            
            chartState.displayedMarkers = chartState.allMarkers;
            
            const markers = chartState.displayedMarkers.map(action => {
                const isBuy = action.action === 'buy';
                const time = action.timestamp.split(' ')[1] || '';
                
                let tooltipHTML = '';
                
                if (isBuy) {
                    tooltipHTML = `
                        <div class="tooltip-header" style="color: #3b82f6;">üîµ BUY ORDER</div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Trade ID:</span>
                            <span class="tooltip-value">#${action.trade_id || 'N/A'}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Entry Price:</span>
                            <span class="tooltip-value">‚Çπ${action.entry_price ? action.entry_price.toFixed(2) : action.price.toFixed(2)}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Quantity:</span>
                            <span class="tooltip-value">${action.quantity || 10}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Time:</span>
                            <span class="tooltip-value">${time}</span>
                        </div>
                    `;
                } else {
                    const pnlColor = action.pnl >= 0 ? '#10b981' : '#ef4444';
                    tooltipHTML = `
                        <div class="tooltip-header" style="color: #f59e0b;">‚≠ê SELL ORDER</div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Trade ID:</span>
                            <span class="tooltip-value">#${action.trade_id || 'N/A'}</span>
                        </div>
                        <div class="tooltip-divider"></div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Entry Price:</span>
                            <span class="tooltip-value">‚Çπ${action.entry_price ? action.entry_price.toFixed(2) : 'N/A'}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Exit Price:</span>
                            <span class="tooltip-value">‚Çπ${action.exit_price ? action.exit_price.toFixed(2) : action.price.toFixed(2)}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Quantity:</span>
                            <span class="tooltip-value">${action.quantity || 10}</span>
                        </div>
                        <div class="tooltip-divider"></div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Gross P&L:</span>
                            <span class="tooltip-value">‚Çπ${action.pnl_gross ? action.pnl_gross.toFixed(2) : 'N/A'}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Fees:</span>
                            <span class="tooltip-value">‚Çπ${action.fees ? action.fees.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Net P&L:</span>
                            <span class="tooltip-value" style="color: ${pnlColor}">‚Çπ${action.pnl ? action.pnl.toFixed(2) : 'N/A'}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Net P&L %:</span>
                            <span class="tooltip-value" style="color: ${pnlColor}">${action.pnl_percent ? action.pnl_percent.toFixed(2) : 'N/A'}%</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Hold Time:</span>
                            <span class="tooltip-value">${action.holding_period_min ? action.holding_period_min.toFixed(2) : 'N/A'} min</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Status:</span>
                            <span class="tooltip-value" style="color: ${pnlColor}">${action.status || 'N/A'}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Time:</span>
                            <span class="tooltip-value">${time}</span>
                        </div>
                    `;
                }
                
                const parsedTime = parseTimestamp(action.timestamp);
                if (parsedTime === null) return null;
                
                return {
                    time: parsedTime,
                    position: isBuy ? 'belowBar' : 'aboveBar',
                    color: isBuy ? '#3b82f6' : '#f59e0b',
                    shape: 'circle',
                    text: isBuy ? 'B' : 'S',
                    size: 1,
                    tooltip: tooltipHTML
                };
            }).filter(m => m !== null);
            
            candleSeries.setMarkers(markers);
            document.getElementById('markers-displayed').textContent = markers.length;
        }

        // ==================== TRADES TABLE ====================
        function renderTrades() {
            const tbody = document.getElementById('trades-tbody');
            const pagination = document.getElementById('pagination');
            const paginationInfo = document.getElementById('pagination-info');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (!allTrades || allTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; color: #94a3b8;">No completed trades yet</td></tr>';
                pagination.style.display = 'none';
                return;
            }
            
            const totalTrades = allTrades.length;
            const totalPages = Math.ceil(totalTrades / tradesPerPage);
            const startIndex = (currentPage - 1) * tradesPerPage;
            const endIndex = Math.min(startIndex + tradesPerPage, totalTrades);
            const currentTrades = allTrades.slice(startIndex, endIndex);
            
            const tradesHTML = currentTrades.map(trade => {
                const entryTime = trade.entry_time.split(' ')[1] || '';
                const exitTime = trade.exit_time.split(' ')[1] || '';
                return `
                    <tr>
                        <td>#${trade.trade_id}</td>
                        <td>${trade.type}</td>
                        <td>‚Çπ${trade.entry_price.toFixed(2)}</td>
                        <td>‚Çπ${trade.exit_price.toFixed(2)}</td>
                        <td>${trade.quantity}</td>
                        <td>${entryTime}</td>
                        <td>${exitTime}</td>
                        <td>${trade.holding_period_min.toFixed(2)}</td>
                        <td style="color: ${trade.pnl >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">‚Çπ${trade.pnl.toFixed(2)}</td>
                        <td style="color: ${trade.pnl_percent >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">${trade.pnl_percent.toFixed(2)}%</td>
                        <td>‚Çπ${(trade.pnl_gross ?? (trade.pnl + (trade.fees ?? 0))).toFixed(2)}</td>
                        <td>‚Çπ${(trade.fees ?? 0).toFixed(2)}</td>
                        <td><span class="trade-status ${trade.status.toLowerCase()}">${trade.status}</span></td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = tradesHTML;
            
            pagination.style.display = 'flex';
            paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalTrades}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }
        
        function changePage(delta) {
            const totalPages = Math.ceil(allTrades.length / tradesPerPage);
            currentPage = Math.max(1, Math.min(currentPage + delta, totalPages));
            renderTrades();
        }
        
        function downloadTradesCSV() {
            if (!allTrades || allTrades.length === 0) {
                alert('No trades to download');
                return;
            }
            
            const headers = [
                'Trade ID',
                'Type',
                'Entry Price',
                'Exit Price',
                'Quantity',
                'Entry Time',
                'Exit Time',
                'Holding Period (min)',
                'P&L',
                'P&L %',
                'P&L (Gross)',
                'Fees',
                'Status'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            allTrades.forEach(trade => {
                const row = [
                    trade.trade_id,
                    trade.type,
                    trade.entry_price.toFixed(2),
                    trade.exit_price.toFixed(2),
                    trade.quantity,
                    trade.entry_time,
                    trade.exit_time,
                    trade.holding_period_min.toFixed(2),
                    trade.pnl.toFixed(2),
                    trade.pnl_percent.toFixed(2),
                    (trade.pnl_gross ?? (trade.pnl + (trade.fees ?? 0))).toFixed(2),
                    (trade.fees ?? 0).toFixed(2),
                    trade.status
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            link.setAttribute('href', url);
            link.setAttribute('download', `trades_report_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ==================== METRICS UPDATE ====================
        function updateMetrics(data) {
            document.getElementById('ltp').textContent = '‚Çπ' + data.current_ltp.toFixed(2);
            
            const m = data.metrics;
            document.getElementById('portfolio-value').textContent = '‚Çπ' + m.portfolio_value.toLocaleString('en-IN');
            
            const pnlEl = document.getElementById('pnl');
            pnlEl.textContent = '‚Çπ' + m.pnl.toLocaleString('en-IN');
            pnlEl.className = 'metric-value ' + (m.pnl >= 0 ? 'positive' : 'negative');
            
            const pnlPercentEl = document.getElementById('pnl-percent');
            pnlPercentEl.textContent = m.pnl_percent.toFixed(2) + '%';
            pnlPercentEl.className = 'metric-value ' + (m.pnl_percent >= 0 ? 'positive' : 'negative');
            
            document.getElementById('trades').textContent = m.total_trades;
            document.getElementById('sharpe').textContent = m.sharpe_ratio.toFixed(2);
            document.getElementById('drawdown').textContent = m.max_drawdown.toFixed(2) + '%';
            
            const ts = data.trade_stats;
            document.getElementById('closed-trades').textContent = ts.total_closed_trades;
            document.getElementById('win-rate').textContent = ts.win_rate.toFixed(2) + '%';
            document.getElementById('winning-trades').textContent = ts.winning_trades;
            document.getElementById('losing-trades').textContent = ts.losing_trades;
            document.getElementById('avg-win').textContent = '‚Çπ' + ts.avg_win.toFixed(2);
            document.getElementById('avg-loss').textContent = '‚Çπ' + Math.abs(ts.avg_loss).toFixed(2);
            document.getElementById('largest-win').textContent = '‚Çπ' + ts.largest_win.toFixed(2);
            document.getElementById('largest-loss').textContent = '‚Çπ' + ts.largest_loss.toFixed(2);
            document.getElementById('profit-factor').textContent = ts.profit_factor.toFixed(2);
            document.getElementById('expectancy').textContent = '‚Çπ' + ts.expectancy.toFixed(2);
            document.getElementById('avg-hold').textContent = ts.avg_holding_period.toFixed(2) + ' min';
            
            const openPosContainer = document.getElementById('open-position-container');
            if (data.open_trade) {
                const ot = data.open_trade;
                const unrealizedPnl = (data.current_ltp - ot.entry_price) * ot.quantity;
                const unrealizedPnlPercent = ((data.current_ltp - ot.entry_price) / ot.entry_price) * 100;
                
                openPosContainer.innerHTML = `
                    <div class="open-position">
                        <div class="open-position-title">üîÑ Open Position</div>
                        <div class="open-position-details">
                            <div class="open-position-item">
                                <span class="open-position-label">Trade ID</span>
                                <span class="open-position-value">#${ot.trade_id}</span>
                            </div>
                            <div class="open-position-item">
                                <span class="open-position-label">Type</span>
                                <span class="open-position-value">${ot.type}</span>
                            </div>
                            <div class="open-position-item">
                                <span class="open-position-label">Entry Price</span>
                                <span class="open-position-value">‚Çπ${ot.entry_price.toFixed(2)}</span>
                            </div>
                            <div class="open-position-item">
                                <span class="open-position-label">Quantity</span>
                                <span class="open-position-value">${ot.quantity}</span>
                            </div>
                            <div class="open-position-item">
                                <span class="open-position-label">Unrealized P&L</span>
                                <span class="open-position-value" style="color: ${unrealizedPnl >= 0 ? '#10b981' : '#ef4444'}">‚Çπ${unrealizedPnl.toFixed(2)}</span>
                            </div>
                            <div class="open-position-item">
                                <span class="open-position-label">Unrealized P&L %</span>
                                <span class="open-position-value" style="color: ${unrealizedPnlPercent >= 0 ? '#10b981' : '#ef4444'}">${unrealizedPnlPercent.toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                openPosContainer.innerHTML = '';
            }
        }
        
        // ==================== MAIN UPDATE FUNCTION ====================
        function updateDashboard() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    const warn = document.getElementById('warning-banner');
                    if (data.last_error && data.last_error.message) {
                        warn.textContent = '‚ö† ' + data.last_error.message;
                        warn.classList.add('active');
                    } else {
                        warn.textContent = '';
                        warn.classList.remove('active');
                    }
                    
                    updateMetrics(data);
                    updateChart(data);
                    
                    if (data.completed_trades) {
                        allTrades = data.completed_trades.slice().reverse();
                        renderTrades();
                    }
                })
                .catch(err => {
                    console.error('Error fetching data:', err);
                    // If error, might mean trading stopped, redirect to config
                    window.location.href = '/';
                });
        }
        
        // ==================== INITIALIZATION ====================
        initChart();
        updateDashboard();
        setInterval(updateDashboard, CONFIG.UPDATE_INTERVAL);
    </script>
</body>
</html>