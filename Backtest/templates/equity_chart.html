<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equity Curve</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="/static/allover.css">
</head>
<body>
    <div class="containerchart1">
        <div class="background"></div>
        <div class="overlay"></div>
        <div class="header">
            <a href="/results" class="back-link">‚Üê Back to Results</a>
            <h1 class="title">üí∞ Portfolio Equity Curve</h1>
            <div></div>
        </div>

        <div class="chart-card1">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <div>Loading chart data...</div>
            </div>
            <div class="chart-container" id="chartContainer" style="display: none;">
                <canvas id="equityChart"></canvas>
            </div>
            <div class="pagination-controls">
                <button class="page-btn" id="prevBtn" onclick="changePage(-1)">‚óÄ Previous</button>
                <div class="page-info" id="pageInfo">Page 1 of 1</div>
                <button class="page-btn" id="nextBtn" onclick="changePage(1)">Next ‚ñ∂</button>
            </div>
            <div class="zoom-info">
                üí° Use mouse wheel to zoom, drag to pan
            </div>
        </div>
    </div>

    <script>
        if (window['chartjs-plugin-zoom']) {
            Chart.register(window['chartjs-plugin-zoom']);
        }

        let equityChart = null;
        let sessionId = null;
        let currentPage = 0;
        let totalPages = 1;

        window.addEventListener('DOMContentLoaded', async function() {
            console.log('Loading equity chart page...');
            
            try {
                const response = await fetch('/api/get_results');
                
                if (!response.ok) {
                    throw new Error('No backtest data found');
                }

                const backtestData = await response.json();
                console.log('Backtest data loaded:', backtestData);
                
                sessionId = backtestData.sessionId;
                totalPages = backtestData.pagination.totalPages;
                
                console.log(`Session ID: ${sessionId}, Total Pages: ${totalPages}`);
                
                await loadPage(0);
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('No backtest data found. Redirecting to results page.');
                window.location.href = '/results';
            }
        });

        async function loadPage(page) {
            try {
                console.log(`Loading page ${page}...`);
                const response = await fetch(`/api/get_page/${sessionId}/${page}`);
                
                if (!response.ok) {
                    console.error('Response not OK:', response.status, response.statusText);
                    throw new Error('Failed to load page');
                }
                
                const data = await response.json();
                console.log('Page data received:', data);
                
                currentPage = data.pagination.currentPage;
                totalPages = data.pagination.totalPages;
                
                if (equityChart) {
                    console.log('Updating existing chart...');
                    updateChart(data);
                } else {
                    console.log('Creating new chart...');
                    createChart(data);
                }
                
                updatePaginationControls();
                
            } catch (error) {
                console.error('Error loading page:', error);
                alert('Failed to load chart data: ' + error.message);
            }
        }

        async function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage < 0 || newPage >= totalPages) return;
            await loadPage(newPage);
        }

        function updatePaginationControls() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = currentPage === totalPages - 1;
        }

        function createChart(data) {
            console.log('Creating equity chart with data:', data);
            
            const ctx = document.getElementById('equityChart');
            if (!ctx) {
                console.error('Canvas element not found!');
                return;
            }
            
            const context = ctx.getContext('2d');

            console.log(`Equity data: ${data.equityCurve.values.length} points`);

            const chartConfig = {
                type: 'line',
                data: {
                    labels: data.equityCurve.timestamps.map((_, i) => i),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: data.equityCurve.values,
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { 
                display: true, 
                position: 'top',
                labels: { 
                    font: { size: 14 },
                    color: 'rgba(255, 255, 255, 0.9)'  // White legend text
                }
            },
            tooltip: {
                callbacks: {
                    title: (ctx) => data.priceData.timestamps[ctx[0].parsed.x],
                    label: (ctx) => `${ctx.dataset.label}: ‚Çπ${ctx.parsed.y.toFixed(2)}`
                }
            }
        },
        scales: {
            x: {
                type: 'linear',
                grid: {
                    color: 'rgba(255, 255, 255, 0.15)',  // Whitish grid lines
                    borderColor: 'rgba(255, 255, 255, 0.3)',  // White border
                    lineWidth: 1
                },
                title: { 
                    display: true, 
                    text: 'Time', 
                    font: { size: 16, weight: 'bold' },
                    color: 'rgba(255, 255, 255, 0.9)'  // White title
                },
                ticks: {
                    callback: (val) => {
                        const idx = Math.floor(val);
                        return idx >= 0 && idx < data.priceData.timestamps.length 
                            ? data.priceData.timestamps[idx].split(' ')[0] 
                            : '';
                    },
                    maxRotation: 45,
                    minRotation: 45,
                    font: { size: 12 },
                    color: 'rgba(255, 255, 255, 0.8)'  // White tick labels
                }
            },
            y: {
                grid: {
                    color: 'rgba(255, 255, 255, 0.15)',  // Whitish grid lines
                    borderColor: 'rgba(255, 255, 255, 0.3)',  // White border
                    lineWidth: 1
                },
                title: { 
                    display: true, 
                    text: 'Price (‚Çπ)', 
                    font: { size: 16, weight: 'bold' },
                    color: 'rgba(255, 255, 255, 0.9)'  // White title
                },
                ticks: { 
                    callback: (val) => '‚Çπ' + val.toFixed(2),
                    font: { size: 12 },
                    color: 'rgba(255, 255, 255, 0.8)'  // White tick labels
                }
            }
        }
    }
};


            // Add zoom plugin if available
            if (window['chartjs-plugin-zoom']) {
    Chart.register(window['chartjs-plugin-zoom'].default || window['chartjs-plugin-zoom']);
            }
            chartConfig.options.plugins.zoom = {
    zoom: {
        wheel: { enabled: true },
        pinch: { enabled: true },
        mode: 'x',
    },
    pan: {
        enabled: true,
        mode: 'x',
    },
    limits: {
        x: { min: 'original', max: 'original' },
        y: { min: 'original', max: 'original' }
    }
};

            equityChart = new Chart(context, chartConfig);
            console.log('Equity chart created successfully!');
            
            // Hide loading, show chart
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'block';
        }

        function updateChart(data) {
            equityChart.data.labels = data.equityCurve.timestamps.map((_, i) => i);
            equityChart.data.datasets[0].data = data.equityCurve.values;
            
            equityChart.options.scales.x.ticks.callback = function(val) {
                const idx = Math.floor(val);
                return idx >= 0 && idx < data.equityCurve.timestamps.length 
                    ? data.equityCurve.timestamps[idx].split(' ')[0] 
                    : '';
            };
            
            equityChart.options.plugins.tooltip.callbacks.title = function(ctx) {
                return data.equityCurve.timestamps[ctx[0].parsed.x];
            };
            
            equityChart.resetZoom();
            equityChart.update();
        }
    </script>
</body>
</html>